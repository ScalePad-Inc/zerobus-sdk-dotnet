name: ci

on:
    push:
        branches:
            - main
    pull_request:

concurrency:
    group: ${{ github.workflow }}
    cancel-in-progress: true

env:
    DOTNET_NOLOGO: true
    DOTNET_CLI_TELEMETRY_OPTOUT: 1

jobs:
    build-native:
        name: build-native
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Cache Rust
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      zerobus-ffi/target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('zerobus-ffi/Cargo.lock') }}

            - name: Build native library
              run: bash build_native.sh

            - name: Upload native library
              uses: actions/upload-artifact@v4
              with:
                  name: native-library
                  path: src/Zerobus/runtimes/
                  retention-days: 1

    lint:
        name: lint
        runs-on: ubuntu-latest
        env:
            SkipNativeBuild: true
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: 10.0.x
                  dotnet-quality: preview

            - name: Install dotnet-format
              run: |
                  dotnet tool install -g dotnet-format
                  echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

            - name: Format check
              run: dotnet format Zerobus.slnx --verify-no-changes

    build:
        name: build
        runs-on: ubuntu-latest
        needs: build-native
        env:
            SkipNativeBuild: true
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: 10.0.x
                  dotnet-quality: preview

            - name: Download native library
              uses: actions/download-artifact@v4
              with:
                  name: native-library
                  path: src/Zerobus/runtimes/

            - name: List native library contents
              run: find src/Zerobus/runtimes/ -type f | sort

            - name: Build
              run: dotnet build Zerobus.slnx

    test:
        name: test
        runs-on: ubuntu-latest
        env:
            SkipNativeBuild: true
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: 10.0.x
                  dotnet-quality: preview
            - name: Unit tests
              run: dotnet test tests/Zerobus.Tests/Zerobus.Tests.csproj

    integration:
        name: integration
        runs-on: ubuntu-latest
        needs: build-native
        env:
            SkipNativeBuild: true
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: 10.0.x
                  dotnet-quality: preview

            - name: Download native library
              uses: actions/download-artifact@v4
              with:
                  name: native-library
                  path: src/Zerobus/runtimes/

            - name: List native library contents
              run: find src/Zerobus/runtimes/ -type f | sort

            - name: Integration tests
              run: dotnet test tests/Zerobus.IntegrationTests/Zerobus.IntegrationTests.csproj
